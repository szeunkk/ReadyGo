아래의 조건을 모두 적용하여, 아래의 요구사항을 모두 구현할 것.
구현 결과를 체크리스트로 반환할 것.

==============================================

조건-커서룰) 아래의 커서룰을 적용하여 작업하고, 이 작업이 끝나면 해당 rules 적용 결과를 체크리스트로 반환할 것.
            - @01-common.mdc
            - @04-func.mdc

==============================================

조건-파일경로) 참고 및 기준 파일 경로는 다음과 같음
            - 구현 대상 파일 경로
                - Route Handler
                    - src/app/api/traits/submit/route.ts
                    - 책임: 인증, 요청 검증, service 호출, 응답 반환                    
                
                - Service 레이어
                    - src/services/traits/submitTraits.service.ts
                    - 책임
                        - userId와 검증된 payload를 입력으로 받는다
                        - traits/profile/schedule 저장 흐름을 orchestration 한다
                        - repository 함수들을 순차적으로 호출한다
                        - 중간 실패 시 즉시 중단하고 에러를 throw 한다

                - Repository 레이어
                    - src/repositories/userTraits.repository.ts: user_traits 테이블 접근 전담
                    - src/repositories/userProfiles.repository.ts: user_profiles 테이블 접근 전담
                    - src/repositories/userPlaySchedules.repository.ts: user_play_schedules 테이블 접근 전담

                
            - Route Handler에서 Supabase 쿼리를 직접 호출하는 구현을 허용하지 않는다.  

            - 포함되어야 하는 타입/상수
                - TraitKey: src/commons/constants/animal/trait.enum.ts
                - AnimalType: src/commons/constants/animal/animal.enum.ts
                - DayTypes, TimeSlots: src/components/traits/data/questionSchedule.ts
            - supabase 서버 클라이언트 생성 유틸: src/lib/supabase/server.ts

==============================================

조건-구현참고) 반드시 참고할 기존 구현 패턴은 다음과 같다.
            - 기존 traits 도메인 구현 패턴을 참고할 것.
	            - traits/domain/calculateTraitScores.ts
	            - traits/domain/resolveAnimalType.ts
	            - 있으면 payload shape 참고만, Route는 body를 신뢰하지 말고 검증
	        - Supabase 쿼리 패턴 (Repository 레이어 기준)
                - 실제 supabase 쿼리는 route handler에서 직접 작성하지 않는다.
                - 모든 DB 접근은 repositories 레이어로 위임한다.

            - 인증 패턴:
                - route handler에서 supabase.auth.getUser()로 인증할 것.
                - Route Handler에서 쿠키 기반 auth를 읽을 수 있는 “server client” 패턴을 반드시 따를 것.
                - user.id를 service 레이어로 전달한다.

            - Repository 구현 패턴
                - user_traits 저장: userTraitsRepository.upsert(userId, traits)
                    ↳ 내부에서 supabase.from('user_traits').upsert(...)
                - user_profiles 업데이트: userProfilesRepository.updateAnimalType(userId, animalType)
                    ↳ 내부에서 supabase.from('user_profiles').update(...).eq('user_id', userId)
                - user_play_schedules 교체 저장:
                    - userPlaySchedulesRepository.deleteByUserId(userId)
                    ↳ supabase.from('user_play_schedules').delete().eq('user_id', userId)
                    - userPlaySchedulesRepository.insertMany(rows)
                    ↳ supabase.from('user_play_schedules').insert([...])

            - Service 레이어 책임
                - Route Handler로부터 userId와 검증된 payload를 받는다.
                - repository 함수들을 순차적으로 호출하여 저장 흐름을 구성한다.
                - 에러 발생 시 즉시 중단하고 상위로 에러를 전달한다.

==============================================

핵심요구사항) 0. 범위·전제 확정
            - 대상: POST /api/traits/submit
            - 목적: 클라이언트에서 계산된 Traits 결과를 단일 요청으로 저장
                - user_traits
                - user_profiles.animal_type
                - user_play_schedules
            - API는 계산 로직을 수행하지 않으며, 결과를 검증 후 저장만 담당한다.

핵심요구사항) 1. 인증
            - Route Handler에서 Supabase Auth로 현재 유저를 조회한다.
            - 본 서비스는 로그인 필수 서비스이며, 정상적인 UI 경로에서는 비로그인 요청이 발생하지 않도록 이미 가드되어있다.
                - 그럼에도 불구하고, 세션 만료·비정상 요청에 대비하여 인증 정보가 없는 경우 API 레벨에서는 401로 종료한다.
            - 모든 저장 로직은 auth로부터 얻은 user.id만 사용한다.
            - 요청 body에 user_id가 포함된 경우 400으로 거부한다. ("user_id is not allowed")

핵심요구사항) 2. 요청 Body 검증
            - JSON 요청만 허용한다.
            - 필수 필드:
                - traits
                - AnimalType
                - DayTypes
                - TimeSlots
            - 검증 규칙
                - traits: Trait 5개 모두 포함 + 각 값은 0~100 number
                - AnimalType: AnimalType enum/union에 정의된 값 중 하나
                - DayTypes, TimeSlots: 각각 DayTypes, TimeSlots 상수에 정의된 id 값 중 하나도
            - schedule 조합 생성 및 중복 제거 규칙
                - DayTypes와 TimeSlots는 각각 중복 제거(set) 후 사용한다.
                - 조합은 다음 형태로 생성한다: { day_type: DayTypeId; time_slot: TimeSlotId }
                - 조합 생성 후에도 { day_type, time_slot } 기준으로 중복 제거를 한 번 더 수행한다
                - 최종 조합 결과가 0건인 경우: user_play_schedules에 대한 insert는 수행하지 않는다.

핵심요구사항) 3. 저장 흐름 (Service 레이어 책임)
            - Service 레이어에서 아래 순서로 저장을 orchestration 한다
                (1) user_traits upsert (user_id 기준)
                (2) user_profiles.animal_type 업데이트
                (3) user_play_schedules 교체 저장 (delete -> insert)

            - 각 단계 실패 시
                - 즉시 중단
                - 상위(Route)로 에러 전달

핵심요구사항) 4. Repository 규칙
            - 모든 Supabase 쿼리는 Repository 레이어에 위치한다.
            - Repository는
                - 인증 로직을 포함하지 않는다.
                - user_id를 인자로 받아 .eq('user_id', userId) 조건을 강제한다.

핵심요구사항) 5. 에러/응답 규칙
            - 실패 응답 형시기 { message, detail }
            - 상태 코드 정책
                - 401: 인증 실패
                - 400: 요청 형식/검증 실패
                - 500: 저장 중 서버/DB 오류
            - 성공 시 { ok: true } 반환

핵심요구사항) 6. 원자성 한계 명시
            - 다중 테이블 트랜잭션은 보장되지 않는다.
            - 일부 단계 성공 후 실패가 발생할 수 있음을 코드 주석으로 명시한다.
            - 필요 시 RPC로 묶을 수 있으나, 이번 구현 범위에서는 제외한다.

==============================================

구현 완료 후 반환 체크리스트) 구현 완료 후 아래 체크리스트를 반환할 것.
	- POST /api/traits/submit Route Handler 존재
	- Supabase auth 기반 인증 처리
	- body.user_id 전달 시 400 거부
	- traits / animalType / schedule 검증
	- user_traits upsert
	- user_profiles.animal_type update
	- user_play_schedules delete → insert
	- 동일 유저 재요청 시 항상 갱신
	- 성공 시 { ok: true } 반환
